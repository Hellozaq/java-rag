<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <!-- å¼•å…¥ Layui CSS æ–‡ä»¶ -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/layui/2.8.12/css/layui.min.css">
    <style>
        /* æ•´ä½“é¡µé¢å®¹å™¨ */
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å®šä¹‰èŠå¤©åŒºåŸŸçš„æ ·å¼ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            border: none;
            padding: 0;
        }

        /* å®šä¹‰æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 10px;
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
        }

        /* å¯¹æ–¹æ¶ˆæ¯æ ·å¼ */
        .message.other {
            background-color: #f1f0f0;
            float: left;
            clear: both;
        }

        /* æˆ‘æ–¹æ¶ˆæ¯æ ·å¼ */
        .message.self {
            background-color: #0084ff;
            color: white;
            float: right;
            clear: both;
        }

        /* å®šä¹‰è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®åŒºåŸŸæ ·å¼ */
        .input-area {
            padding: 10px 0;
            /* å»æ‰é¡¶éƒ¨è¾¹æ¡† */
            border-top: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            z-index: 100;
        }

        /* è®©è¾“å…¥æ¡†å’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œæ˜¾ç¤º */
        .layui-form-item {
            display: flex;
            align-items: center;
        }

        .layui-input {
            flex: 1;
            margin-right: 10px;
        }

        /* ç¡®ä¿å®¹å™¨å†…å…ƒç´ åŒç«¯å¯¹é½ */
        .layui-container {
            max-width: 800px;
            margin: 0 auto;
            width: 90%; /* å¯ä»¥è°ƒæ•´è¿™ä¸ªå€¼æ¥æ§åˆ¶å·¦å³è¾¹è· */
        }
    </style>
</head>

<body>
<!-- æ•´ä½“é¡µé¢å®¹å™¨ -->
<div class="page-container">
    <!-- å¼•å…¥ Layui å®¹å™¨ -->
    <div class="layui-container">
        <!-- å¼•å…¥ Layui è¡Œ -->
        <div class="layui-row">
            <!-- æ ¸å¿ƒåŒºåŸŸï¼Œå  12 åˆ— -->
            <div class="layui-col-md12">
                <!-- èŠå¤©å†å²æ¶ˆæ¯å±•ç¤ºåŒºåŸŸ -->
                <div class="chat-container" id="chatHistory">
                    <div class="message self">æˆ‘ï¼šä½ å¥½</div>
                    <!-- å¯¹æ–¹æ¶ˆæ¯ -->
                    <div class="message other">ğŸ¤–ï¼šä½ å¥½ï¼æˆ‘æ˜¯æœºå™¨äººåŠ©ç†ï¼Œæˆ‘èƒ½å›ç­”å„ç±»çŸ¥è¯†é—®é¢˜ï¼Œå¦‚ç§‘å­¦ã€å†å²ã€æ–‡åŒ–ç­‰ï¼›åˆ›ä½œå¤šç§æ–‡æœ¬ï¼Œåƒè¯—æ­Œã€å°è¯´ã€è®¡åˆ’ä¹¦ï¼›è¾…åŠ©è¯­è¨€å­¦ä¹ ï¼ŒåŒ…æ‹¬è¯­æ³•ã€ç¿»è¯‘ï¼›å¯å‘åˆ›æ„ï¼Œå¦‚å¹¿å‘Šã€æ‰‹å·¥çµæ„Ÿï¼›é™ªæ—¥å¸¸é—²èŠï¼Œå€¾å¬åˆ†äº«æƒ…ç»ªï¼›è§£é€»è¾‘æ¨ç†é¢˜ï¼›æ•´ç†æ€»ç»“ä¿¡æ¯ï¼›æä¾›ç¼–ç¨‹ä»£ç ç¤ºä¾‹å¹¶ååŠ©è§£å†³ç¼–ç¨‹é—®é¢˜ã€‚</div>

                    <div class="message self">æˆ‘ï¼šå¿™äº†ä¸€å¤©å·¥ä½œã€‚</div>

                    <div class="message other">ğŸ¤–ï¼šè¾›è‹¦äº†å‘€ï¼Œå¿™äº†ä¸€å¤©å·¥ä½œè‚¯å®šæŒºç´¯çš„ã€‚å¿«åä¸‹æ¥å¥½å¥½ä¼‘æ¯ä¼‘æ¯ï¼Œæ”¾æ¾ä¸€ä¸‹ã€‚å¯ä»¥å’Œæˆ‘è¯´è¯´ä»Šå¤©å·¥ä½œä¸Šæœ‰æ²¡æœ‰å‘ç”Ÿä»€ä¹ˆç‰¹åˆ«çš„äº‹å„¿ï¼Œä¸ç®¡æ˜¯å¼€å¿ƒçš„è¿˜æ˜¯è®©ä½ è§‰å¾—æœ‰ç‚¹å°éƒé—·çš„ï¼Œéƒ½èƒ½è·Ÿæˆ‘èŠèŠï¼Œè¯´ä¸å®šè¯´å‡ºæ¥ä¼šæ„Ÿè§‰è½»æ¾ä¸å°‘å‘¢ã€‚ </div>
                </div>
            </div>
        </div>
    </div>
    <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®åŒºåŸŸï¼Œå  12 åˆ— -->
    <div class="layui-row">
        <div class="layui-col-md12 input-area">
            <div class="layui-container">
                <form class="layui-form" id="chatForm">
                    <div class="layui-form-item">
                        <input type="text" id="inputMessage" placeholder="è¯·è¾“å…¥æ¶ˆæ¯" class="layui-input">
                        <input type="file" id="fileInput" style="display: none;">
                        <button class="layui-btn" id="sendButton">å‘é€</button>
                        <button class="layui-btn" id="uploadButton">ä¸Šä¼ æ–‡ä»¶</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ layui.js -->
<script src="//unpkg.com/layui@2.9.21/dist/layui.js"></script>
<script>
    layui.use(['jquery'], function () {
        var $ = layui.jquery;

        // ç‚¹å‡»å‘é€æŒ‰é’®äº‹ä»¶
        $('#sendButton').on('click', function (e) {
            // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸ºï¼Œé¿å…é¡µé¢åˆ·æ–°
            e.preventDefault();

            // æ‰“å°æ—¥å¿—åˆ°æ§åˆ¶å°
            console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡»');
            var message = $('#inputMessage').val();
            if (message) {
                // æ·»åŠ æ–°æ¶ˆæ¯åˆ°èŠå¤©å†å²
                $('#chatHistory').append('<div class="message self">æˆ‘ï¼š' + message + '</div>');
                // æ¸…ç©ºè¾“å…¥æ¡†
                $('#inputMessage').val('');
                // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                $.ajax({
                    url: 'http://localhost:8080/send',
                    method: 'POST',
                    data: { message: message },
                    dataType: 'json', // æŒ‡å®šè¿”å›æ•°æ®ç±»å‹ä¸º JSON
                    success: function (response) {
                        // è·å–ç”Ÿæˆçš„å›å¤æ¶ˆæ¯
                        var generatedText = response.generatedText;
                        // æ·»åŠ æœºå™¨äººçš„å›å¤æ¶ˆæ¯åˆ°èŠå¤©å†å²
                        $('#chatHistory').append('<div class="message other">ğŸ¤–ï¼š' + generatedText + '</div>');
                        // æ»šåŠ¨åˆ°èŠå¤©å†å²åº•éƒ¨
                        $('#chatHistory').scrollTop($('#chatHistory')[0].scrollHeight);
                    },
                    error: function () {
                        console.log('è¯·æ±‚å¤±è´¥');
                    }
                });
            }
        });

        // ç›‘å¬è¾“å…¥æ¡†æŒ‰ä¸‹å›è½¦é”®äº‹ä»¶
        $('#inputMessage').on('keydown', function (e) {
            if (e.keyCode === 13) {
                $('#sendButton').click();
            }
        });

        // ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶æŒ‰é’®äº‹ä»¶
        $('#uploadButton').on('click', function (e) {
            e.preventDefault();
            $('#fileInput').click();
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        $('#fileInput').on('change', function () {
            var file = this.files[0];
            if (file) {
                // åˆ›å»º FormData å¯¹è±¡
                var formData = new FormData();
                formData.append('isFile', 'true');
                formData.append('file', file);
                formData.append('originalFileName', file.name);

                // æ˜¾ç¤ºæ­£åœ¨ä¸Šä¼ çš„æç¤º
                $('#chatHistory').append('<div class="message self">æˆ‘ï¼šæ­£åœ¨ä¸Šä¼ æ–‡ä»¶ï¼Œè¯·ç¨å€™...</div>');
                $('#chatHistory').scrollTop($('#chatHistory')[0].scrollHeight);

                // å‘é€æ–‡ä»¶åˆ°æœåŠ¡å™¨
                $.ajax({
                    url: 'http://localhost:8080/sendFile',
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        try {
                            var responseJson = JSON.parse(response);
                            // è·å–ç”Ÿæˆçš„å›å¤æ¶ˆæ¯
                            var generatedText = responseJson.generatedText;
                            // æ·»åŠ æœºå™¨äººçš„å›å¤æ¶ˆæ¯åˆ°èŠå¤©å†å²
                            $('#chatHistory').append('<div class="message other">ğŸ¤–ï¼š' + generatedText + '</div>');
                        } catch (error) {
                            console.log('è§£æå“åº”æ•°æ®å¤±è´¥:', error);
                            $('#chatHistory').append('<div class="message other">ğŸ¤–ï¼šè§£ææœåŠ¡å™¨å“åº”å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>');
                        }
                        // æ»šåŠ¨åˆ°èŠå¤©å†å²åº•éƒ¨
                        $('#chatHistory').scrollTop($('#chatHistory')[0].scrollHeight);
                    },
                    error: function () {
                        console.log('æ–‡ä»¶ä¸Šä¼ è¯·æ±‚å¤±è´¥');
                        $('#chatHistory').append('<div class="message other">ğŸ¤–ï¼šæ–‡ä»¶ä¸Šä¼ æˆ–å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>');
                        $('#chatHistory').scrollTop($('#chatHistory')[0].scrollHeight);
                    }
                });
            }
        });
    });
</script>
</body>

</html>